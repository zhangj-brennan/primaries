<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="state_abbr.js"></script>
    <title>just for fun</title>
    <style>
        @font-face {
      font-family: "Benton";
      src: url("Benton Sans/Benton Sans Book.otf");
    }
    @font-face {
      font-family: "BentonStrong";
      src: url("Benton Sans/Benton Sans Bold.otf");
    }
    body{
        font-family: "BentonStrong";
        font-size:24px;
        padding:10px;

    }
    svg text { font-family: "BentonStrong";font-size:14px;}
    button { margin-right: 10px; }
    .section{
        padding:10px;
    }

    #main{
    }
.state text {
    font-family: "Benton";  
    text-anchor: middle;
    font-weight:800;
    fill:#fff;
    letter-spacing:1px;
}
.chart{
    font-size:12px;
}
#text{
    height:90px;
}
#seats{
 height:90px;
    margin:auto;
}
 .highlight{
    color:red;
 }  
 .footnote{
    font-size:9px;
 }
 #applet{
    background-color:black;
    padding:20px;
color:white;
     width:400px;
    min-width: 400px;
    margin:auto;
    margin-top:20px;
 }
  </style>
</head>
<body>
    <!-- Your content will go here -->
     <div id="applet">
<div class="section" id="title">
    Today is ...
</div>
<!-- <div class="chart" id="timeline">distribution of primaries</div> -->

<div class="section" id="text">
</div>
<div class="section" id="seats">
</div>
<div class="chart" id="map"></div>

<div class="footnote">from: 
https://www.ncsl.org/elections-and-campaigns/2026-state-primary-election-dates</div>
</div>

<!-- <div class="chart" id="timeline"></div> -->
<script id="grid" type="text/plain">
                              ME
               WI          VT NH
WA ID MT ND MN IL MI    NY MA
OR NV WY SD IA IN OH PA NJ CT RI
CA UT CO NE MO KY WV VA MD DE
   AZ NM KS AR TN NC SC
         OK LA MS AL GA
HI AK    TX             FL
</script>


    <script>

//charts:
//current
//average age
//average tenure
//longest serving
//think of a wrap up

        const red = "#ED1C24"
        const blue = "#3995B2"
        const yellow = "#FFCF01"
        const grey = "#B0B0B0"

            const oneDay = 1000 * 60 * 60 * 24;


Promise.all([d3.csv("midterm election 2026 general - primary_date.csv"),d3.csv("midterm election 2026 general - seats.csv")])
.then(function(data){

    
    const seatsData = data[1]

    var stateSeatsDictionary = seatsDictionary(seatsData)
    const today = new Date();

    const weekday = today.toLocaleDateString('en-EN', { weekday: 'long' });
    const date = today.getDate();
    const month = today.getMonth() + 1;
    const year = today.getFullYear();
    const longMonth = today.toLocaleString('default', { month: 'long' });

    d3.select("#title").html("Today is "+weekday+" "+longMonth+" "+date+", "+year)

    var primaryDates = data[0]
    var primaryDictionary={}
    for(var i in primaryDates){
        primaryDictionary[primaryDates[i]["State"]]=primaryDates[i]["Primary Date"]
    }

    var grouped = Object.groupBy(primaryDates, function(d){return d["Primary Date"]})
    getNextPrimary(grouped)
   // console.log(grouped)
    //make date objects for each state
    //make a calendar timeline
    //make math subtraction
    drawGrid(primaryDictionary,primaryDates,grouped,stateSeatsDictionary)
   // drawDays("TX",primaryDictionary,primaryDates)
    d3.select("#TX_rect").style("stroke","black").style("stroke-width",2)
    d3.select("#NC_rect").style("stroke","black").style("stroke-width",2)
    d3.select("#AR_rect").style("stroke","black").style("stroke-width",2)
})

function seatsDictionary(seatsData){
    var stateDict = {}
    for(var s in seatsData){
        stateDict[ state_abbr[seatsData[s].State]]=seatsData[s]
    }
    seatsData.reduce(function(a,currentItem){
        //console.log(currentItem.State)
        var stateAbbr = state_abbr[currentItem.State]
        stateDict[stateAbbr]=currentItem
       // return stateDict
    })
    return stateDict
}

function getNextPrimary(grouped){
   // console.log(grouped)

    var todayFormatted = new Date().toLocaleString().split(",")[0]
    grouped[todayFormatted]="today"
  //  console.log(todayFormatted)
    var dates = Object.keys(grouped)
    var datesSorted =dates.sort(function(a,b){
        return new Date(a)- new Date(b)
    })
  //  console.log(datesSorted)
    var todayIndex = datesSorted.indexOf(todayFormatted)
  //  console.log(todayIndex)
    var nextPDate = datesSorted[todayIndex+1]

    var nextDateObject = new Date(nextPDate)
    const nWeekday = nextDateObject.toLocaleDateString('en-EN', { weekday: 'long' });
    const nDate = nextDateObject.getDate();
    const nMonth = nextDateObject.getMonth() + 1;
    const nYear = nextDateObject.getFullYear();
    const nLongMonth = nextDateObject.toLocaleString('default', { month: 'long' });

    var daysTill =Math.floor((nextDateObject-new Date())/oneDay)

    var nextPStates = grouped[nextPDate]
    if(nextPStates.length==1){
        var nextText = "The next primary is on "+nextPDate+" in "+nextPStates[0].Stat
    }else{
        var statesString = ""
        for(var s in nextPStates){
            if(s ==nextPStates.length-1){
                statesString+=" and "+ nextPStates[s].State
            }else{
                statesString+=" "+nextPStates[s].State+","
            }
        }

        var nextText = "The next primaries are in <span class=\"highlight\">"
            +daysTill+" days</span> on "+nWeekday+" "+nLongMonth
        +" "+nDate+" in<span class=\"highlight\">"+statesString+"</span>."
    }
    d3.select("#text").html(nextText)
}

function displaySeats(seatsData){

    d3.select("#seats").html("")
//    var table = d3.select("#seats")
//     .append("table")//.attr("border","1")
const columns = [
    { key: "marker", label: seatsData.State },      // blank header
    { key: "term",   label: "Term" },
    { key: "open",   label: "Up in 2026" },
    { key: "total",  label: "Out of " }
  ];


//   const thead = table.append("thead");
//   const tbody = table.append("tbody");

  // 2) Your data (rows)
  const data = [
    { marker: "House", term: seatsData["House Term"],   
    open: seatsData["House Seats up in 2026"], 
    total: seatsData["Total House Seats"] },
    { marker: "Senate", 
    term: seatsData["Senate Term"], 
    open: seatsData["Senate Seats up in 2026"], 
    total: seatsData["Total Senate Seats"]}
  ];

  if(seatsData["House Seats up in 2026"]==seatsData["Total House Seats"]){
    var houseText = "In "+seatsData.State+", all "
    +seatsData["House Seats up in 2026"]
    +" House seats, and "
  }else if(seatsData["House Seats up in 2026"]==0){
    var houseText ="In "+seatsData.State+ " none of the "
        +seatsData["Total House Seats"]
        +", and"
  }else{
    var houseText = "In "+seatsData.State+", "
     +seatsData["House Seats up in 2026"]
    + " out of "+seatsData["Total House Seats"]
     +" House seats, and "
  }

  if(seatsData["Senate Seats up in 2026"]==seatsData["Total Senate Seats"]){
    var senateText = "all "
    +seatsData["Senate Seats up in 2026"]
    +" Senate seats are up in 2026."
  }else if(seatsData["Senate Seats up in 2026"]==0){
    var senateText = " none of the "
        +seatsData["Total Senate Seats"]
        +" Senate seats are up in 2026."
  }
  else{
    var senateText = seatsData["Senate Seats up in 2026"]
    + " out of "+seatsData["Total Senate Seats"]
     +" Senate seats are up in 2026."
  }




  d3.select("#seats").html(houseText+senateText)

//    thead.append("tr")
//     .selectAll("th")
//     .data(columns)
//     .join("th")
//       .text(d => d.label)
//    //   .style("border", "1px solid #ccc")
//       .style("padding", "6px 8px")
//      // .style("text-align", d => (d.key === "open" || d.key === "total") ? "right" : "left");
//     const rows = tbody.selectAll("tr")
//     .data(data)
//     .join("tr");
//       rows.selectAll("td")
//     .data(row => columns.map(c => ({ col: c, value: row[c.key] })))
//     .join("td")
//       .text(d => d.value)
//      // .style("border", "1px solid #ddd")
//       .style("padding", "6px 8px")


}

function drawGrid(primaryDictionary,primaryDates,grouped,seats){
    var states = [],
    selectedStates = ["MA", "MD", "ME", "MI", "MN", "MO", "MS", "MT"];

    d3.select("#grid").text().split("\n").forEach(function(line, i) {
    var re = /\w+/g, m;
    while (m = re.exec(line)) states.push({
    name: m[0],
    selected: selectedStates.indexOf(m[0]) >= 0,
    x: m.index / 3,
    y: i
    });
    });

    var width = 420;
    var height = 300;
    var svg = d3.select("#map").append("svg").attr("width",width).attr("height",height)

    var gridWidth = d3.max(states, function(d) { return d.x; }) + 1,
    gridHeight = d3.max(states, function(d) { return d.y; }) + 1,
    cellSize = 34;


    var daysColor = d3.scaleLinear().domain([20,200]).range([red,grey])

    var state = svg.append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
    .selectAll(".state")
    .data(states)
    .enter().append("g")
    .attr("cursor","pointer")
    .attr("id",function(d){return d.name})
    .attr("class", function(d) { return "state" + (d.selected ? " state--selected" : ""); })
    .attr("transform", function(d) { return "translate(" + (d.x - gridWidth / 2) * cellSize + "," + (d.y - gridHeight / 2) * cellSize + ")"; });
    
    state.append("rect")
    .attr("x", -cellSize / 2+2)
    .attr("y", -cellSize / 2+2)
    .attr("width", cellSize - 4)
    .attr("height", cellSize - 4)
    .attr("days",function(d){
        return calculateDays(d.name,primaryDictionary,primaryDates)[1]
    })
    .attr("fill",function(d){
        return daysColor(d3.select(this).attr("days"))
    })
    .attr("id",function(d){return d.name+"_rect"})
    .on("mouseover",function(e,d,i){
            d3.selectAll("rect").style("stroke","black").style("stroke-width",0)

    //d3.selectAll('rect').style("fill","black")
        d3.select(this).style("stroke","black").style("stroke-width",2)
      
        displaySeats(seats[d.name])
        drawDays(d.name,primaryDictionary,primaryDates)
    })
    .on("mouseout",function(e,d,i){
        d3.select(this).style("stroke-width",0)
            d3.select("#text").html("")
            d3.select("#seats").html("")
getNextPrimary(grouped)
       //d3.select(this).style("fill","black")
    })

    state.append("text")
    .attr("dy", ".35em")
    .text(function(d) { 
        return d.name; })
    .attr("id",function(d){return d.name+"_text"})
    .on("mouseover",function(e,d,i){
      //  console.log(d.name)
       drawDays(d.name,primaryDictionary,primaryDates)
        d3.selectAll("rect").style("stroke","black").style("stroke-width",0)
        displaySeats(seats[d.name])

        var rectId = d3.select(this).attr("id").replace("_text","_rect")
        d3.select("#"+rectId).style("stroke","black").style("stroke-width",2)
    })
      .on("mouseout",function(e,d,i){
        var rectId = d3.select(this).attr("id").replace("_text","_rect")
        d3.select("#"+rectId).style("stroke","black").style("stroke-width",0)    
        d3.select("#text").html("")
            d3.select("#seats").html("")

        getNextPrimary(grouped)
    })
}

function drawDays(state,primaryDictionary,primaryDates){
    var newText = calculateDays(state,primaryDictionary,primaryDates)[0]
    d3.select("#text").html(newText)
}

function calculateDays(state,primaryDictionary,primaryDates){
    var svg = d3.select("#timeline").append("svg")
    .attr("width",80000).attr("height",200)
    var minDate = d3.min([new Date(), new Date("3/1/2026")])
    var maxDate = d3.max(primaryDates,function(d){return new Date(d["Primary Date"])})

    var stateFullName = abbr_state[state]
    var stateDate = new Date(primaryDictionary[stateFullName])
    var today = new Date()
    var days =Math.floor((stateDate-today)/oneDay)
    //console.log(days, stateDate, stateFullName)

    const weekday = stateDate.toLocaleDateString('en-EN', { weekday: 'long' });
    const date = stateDate.getDate();
    const month =stateDate.getMonth() + 1;
    const year = stateDate.getFullYear();
    const longMonth = stateDate.toLocaleString('default', { month: 'long' });

    if(days>1){
        var newText = "There are <span class=\"highlight\">"+days
            +" days</span> until the primary in <span class=\"highlight\">"
            + stateFullName+ "</span> on "
            + weekday+" "+longMonth+" "+date+", "+year
    }else if(days==1){
         var newText = "There is <span class=\"highlight\">just "+days
            +" day</span> until the primary in <span class=\"highlight\">"
            + stateFullName+ "</span> on "
            + weekday+" "+longMonth+" "+date+", "+year
    }else if(days==0){
         var newText = "The primary in <span class=\"highlight\">"
            + stateFullName+ "</span> is today "
            + weekday+" "+longMonth+" "+date+", "+year
    }else{
         var newText = "The primary in <span class=\"highlight\">"
            + stateFullName+ "</span> was "+Math.abs(days)+" days ago, "
            + weekday+" "+longMonth+" "+date+", "+year
    }
    return([newText,days])
}

</script>
</body>
</html>